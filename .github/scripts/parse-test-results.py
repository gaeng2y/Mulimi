#!/usr/bin/env python3
"""
UseCase í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹± ìŠ¤í¬ë¦½íŠ¸
GitHub Actionsì—ì„œ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ êµ¬ì¡°í™”í•©ë‹ˆë‹¤.
"""

import re
import sys
import json
from typing import Dict, List, Any

def parse_xcodebuild_log(log_file: str) -> Dict[str, Any]:
    """xcodebuild ë¡œê·¸ì—ì„œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ íŒŒì‹±í•©ë‹ˆë‹¤."""
    
    results = {
        'total_tests': 0,
        'passed_tests': 0,
        'failed_tests': 0,
        'success_rate': 0.0,
        'failed_test_details': [],
        'test_suites': []
    }
    
    try:
        with open(log_file, 'r', encoding='utf-8') as f:
            content = f.read()
    except FileNotFoundError:
        return results
    
    # Test Case íŒ¨í„´ ë§¤ì¹­
    test_case_pattern = r"Test Case '(.+?)' (passed|failed) \((.+?)\)"
    test_cases = re.findall(test_case_pattern, content)
    
    # ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ì˜ ìƒì„¸ ì •ë³´ íŒ¨í„´
    failure_pattern = r"Test Case '(.+?)' failed.*?\n(.*?)(?=Test Case|\Z)"
    failures = re.findall(failure_pattern, content, re.DOTALL)
    
    # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì§‘ê³„
    for test_name, status, duration in test_cases:
        results['total_tests'] += 1
        if status == 'passed':
            results['passed_tests'] += 1
        else:
            results['failed_tests'] += 1
            
    # ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ìƒì„¸ ì •ë³´ ìˆ˜ì§‘
    for test_name, failure_detail in failures:
        # ë¶ˆí•„ìš”í•œ ë¡œê·¸ ì œê±°í•˜ê³  í•µì‹¬ ì—ëŸ¬ ë©”ì‹œì§€ë§Œ ì¶”ì¶œ
        clean_detail = re.sub(r'\s+', ' ', failure_detail.strip())
        clean_detail = clean_detail[:300] + '...' if len(clean_detail) > 300 else clean_detail
        
        results['failed_test_details'].append({
            'test_name': test_name,
            'failure_message': clean_detail
        })
    
    # ì„±ê³µë¥  ê³„ì‚°
    if results['total_tests'] > 0:
        results['success_rate'] = round(
            (results['passed_tests'] / results['total_tests']) * 100, 1
        )
    
    return results

def format_github_comment(results: Dict[str, Any]) -> str:
    """GitHub ëŒ“ê¸€ìš© ë§ˆí¬ë‹¤ìš´ í¬ë§·ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤."""
    
    status_emoji = 'âœ…' if results['failed_tests'] == 0 else 'âŒ'
    status_text = 'All Tests Passed' if results['failed_tests'] == 0 else 'Some Tests Failed'
    
    # ì§„í–‰ë¥  ë°” ìƒì„±
    if results['total_tests'] > 0:
        passed_ratio = results['passed_tests'] / results['total_tests']
        progress_bar = 'ğŸŸ¢' * int(passed_ratio * 10) + 'ğŸ”´' * int((1 - passed_ratio) * 10)
    else:
        progress_bar = 'âšª' * 10
    
    comment = f"""## {status_emoji} UseCase Layer Test Results

**ğŸ“Š Test Summary:**
- **Total Tests:** {results['total_tests']}
- **Passed:** {results['passed_tests']} âœ…
- **Failed:** {results['failed_tests']} âŒ
- **Success Rate:** {results['success_rate']}%

**Progress:** {progress_bar}

**Status:** {status_text}
"""
    
    # ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ìƒì„¸ ì •ë³´ ì¶”ê°€
    if results['failed_test_details']:
        comment += "\n## ğŸ” Failed Tests Details\n\n"
        for failure in results['failed_test_details']:
            comment += f"âŒ **{failure['test_name']}**\n"
            comment += f"```\n{failure['failure_message']}\n```\n\n"
    
    comment += f"""
---
ğŸ¤– **Generated by GitHub Actions** | ğŸ§ª **Domain Layer Tests** | â° **$(date)**
"""
    
    return comment

def main():
    if len(sys.argv) != 2:
        print("Usage: python3 parse-test-results.py <log_file>")
        sys.exit(1)
    
    log_file = sys.argv[1]
    results = parse_xcodebuild_log(log_file)
    
    # GitHub Actions ì¶œë ¥ ì„¤ì •
    with open('test_results.json', 'w') as f:
        json.dump(results, f, indent=2)
    
    # GitHub Actions í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    with open('github_outputs.txt', 'w') as f:
        f.write(f"total_tests={results['total_tests']}\n")
        f.write(f"passed_tests={results['passed_tests']}\n")
        f.write(f"failed_tests={results['failed_tests']}\n")
        f.write(f"success_rate={results['success_rate']}\n")
    
    # ëŒ“ê¸€ ë‚´ìš© ìƒì„±
    comment = format_github_comment(results)
    with open('github_comment.md', 'w') as f:
        f.write(comment)
    
    # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ exit code 1
    sys.exit(1 if results['failed_tests'] > 0 else 0)

if __name__ == "__main__":
    main()